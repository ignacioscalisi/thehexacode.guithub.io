<!DOCTYPE html><html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Viaje de ROJO16 ‚Äî Web Interactiva</title>
  <style>
    :root{
      --bg:#0b0b12; --fg:#e9e9ef; --muted:#babacc; --accent:#ff415d; --panel:#141423; --verde:#8fe388; --violeta:#b18ae6;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji',sans-serif; background:radial-gradient(1200px 800px at 20% -10%,#1d1d32,transparent),linear-gradient(180deg,#0b0b12 0%, #090910 100%); color:var(--fg);}    
    header{position:sticky; top:0; z-index:10; backdrop-filter: blur(8px); background:rgba(9,9,16,.6); border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:900px; margin:0 auto; padding:16px 20px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:32px; height:32px; border-radius:12px; background:conic-gradient(from 180deg, var(--accent), #ff7a7a, #ffa3a3, var(--accent)); box-shadow:var(--shadow)}
    .brand h1{font-size:18px; margin:0; letter-spacing:.3px}
    main{padding:28px 20px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:var(--shadow); overflow:hidden}
    .card .inner{padding:24px}
    .title{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .title h2{margin:0; font-weight:700; font-size:22px}
    .badge{font-size:12px; color:var(--muted); background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px}

    .consequence{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); padding:14px 16px; border-radius:14px; margin:16px 0}
    .consequence strong{color:var(--muted)}

    .section{margin:16px 0}
    .section h3{margin:.2rem 0 .5rem; font-size:14px; color:var(--muted); font-weight:600; letter-spacing:.4px; text-transform:uppercase}
    .narrative{line-height:1.7; font-size:16px}

    .voice-verde{color:var(--verde); font-style:italic}
    .voice-violeta{color:var(--violeta); font-style:italic}

    .choices{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px}
    button.choice{padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03); color:var(--fg); cursor:pointer; transition:.2s transform ease, .2s background-color ease, .2s border-color ease; font-weight:600}
    button.choice:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    button.choice:active{transform:translateY(0)}

    .footer{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; color:var(--muted); font-size:13px}

    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .controls button{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.02); color:var(--fg); cursor:pointer}

    .progress{height:8px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; margin:12px 0 0}
    .progress > div{height:100%; background:linear-gradient(90deg, var(--accent), #ff7a7a); width:0%}

    /* Transition UI */
    .lock{display:grid; gap:12px; margin-top:16px}
    .lock input{padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03); color:var(--fg); width:100%}
    .lock button{padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:var(--accent); color:#111; font-weight:700; cursor:pointer}
    .hint{font-size:12px; color:var(--muted)}

    @media (max-width:640px){ .choices{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>El Viaje de ROJO16 ‚Äî Interactivo</h1>
    </div>
  </header>
  <main class="wrap">
    <div class="card" role="region" aria-live="polite">
      <div class="inner">
        <div class="title">
          <h2 id="title">Fragmento</h2>
          <span class="badge" id="badge">1 / 9</span>
        </div>
        <div id="consequence" class="consequence" hidden></div>

        <div class="section">
          <h3>Historia</h3>
          <p id="history" class="narrative"></p>
        </div>
        <div class="section" id="verdeSection">
          <h3>VERDE</h3>
          <p id="verde" class="narrative voice-verde"></p>
        </div>
        <div class="section" id="violetaSection">
          <h3>VIOLETA</h3>
          <p id="violeta" class="narrative voice-violeta"></p>
        </div>

        <div id="choices" class="choices"></div>

        <div class="footer">
          <div id="footerHelp">Eleg√≠ con los botones o con el teclado: <strong>A</strong>/<strong>B</strong>.</div>
          <div class="controls">
            <button id="restartBtn" title="Reiniciar">Reiniciar</button>
            <button id="saveBtn" title="Guardar progreso">Guardar</button>
            <button id="loadBtn" title="Cargar progreso">Cargar</button>
          </div>
        </div>
        <div class="progress" aria-hidden="true"><div id="bar"></div></div>
      </div>
    </div>

  </main>

  <script>
    // =====================
    // Datos narrativos ‚Äî Fragmentos (texto exacto provisto)
    // =====================
    const fragments = [
      {
        id:1, title:"üåë Fragmento 1 ‚Äì El Despertar",
        history:`ROJO16 se despert√≥ sobresaltada. El amanecer apenas entraba por la ventana y la habitaci√≥n estaba cubierta por una penumbra suave, esa luz indecisa que no es de noche ni de d√≠a.\nLa sensaci√≥n era clara: hab√≠a so√±ado algo importante‚Ä¶ pero el recuerdo se disolv√≠a como agua entre los dedos.\n\nNo quedaba imagen precisa, solo un eco. Una risa. Y detr√°s de esa risa, la silueta de un √°rbol tan alto que parec√≠a rozar el cielo. El coraz√≥n le lat√≠a con fuerza, como si hubiera estado corriendo dentro de ese sue√±o, o como si lo que hab√≠a vivido all√≠ no fuese del todo un sue√±o.\n\nGir√≥ la cabeza. Sobre la mesa de luz hab√≠a un papel doblado en cuatro. No recordaba haberlo dejado all√≠ la noche anterior. Dud√≥ en tocarlo; la habitaci√≥n entera parec√≠a esperar junto a ella, en un silencio extra√±o.\n\nLo abri√≥ con cuidado. Dentro, apenas con unas l√≠neas torpes de tinta oscura, hab√≠a un dibujo: un √°rbol solitario. Pero la copa no estaba hecha de hojas, sino de una espiral que se extend√≠a hacia afuera, como si tratara de escapar del papel. El trazo parec√≠a vibrar bajo la luz, y por un instante, ROJO16 tuvo la certeza de que el dibujo la estaba observando.\n\nUn mareo la oblig√≥ a cerrar los ojos. Y en ese instante breve, la risa volvi√≥, acompa√±ada de un murmullo que no proven√≠a de su mente ni de la habitaci√≥n.`,
        verde:`‚ÄúDespertar no siempre es abrir los ojos, ROJO.\nEs escuchar lo que todav√≠a late en vos.\nEse papel no es un dibujo: es un espejo.\nEl √°rbol est√° esperando que decidas si volver a recordarlo‚Ä¶\no si vas a seguir corriendo de lo que fuiste.‚Äù`,
        violeta:`‚ÄúEleg√≠, ROJO.\n¬øVas a hundirte en la espiral hacia adentro, reclamando lo que perdiste‚Ä¶\no vas a dejar que la espiral te arrastre hacia afuera, donde nada te pertenece todav√≠a?‚Äù`,
        choices:{A:"Seguir la espiral hacia adentro ‚Üí enfrentar los recuerdos.", B:"Seguir la espiral hacia afuera ‚Üí entregarse a lo desconocido."},
      },
      {
        id:2, title:"üå≥ Fragmento 2 ‚Äì El √Årbol",
        consequence:{
          A:"El peso de la espiral la acompa√±a. El √°rbol aparece frente a ella como un recuerdo que nunca muri√≥.",
          B:"El v√©rtigo de la espiral a√∫n la sacude. El √°rbol surge ahora como una promesa de lo que todav√≠a no existe."
        },
        history:`Frente a vos, el √°rbol inmenso: sus ra√≠ces se hunden como venas negras y sus ramas giran en espiral hacia el cielo. El aire vibra, como si respirara.`,
        verde:`‚ÄúLa memoria y el deseo est√°n en un mismo cuerpo, ROJO.\nLas ra√≠ces sostienen lo que fuiste.\nLas ramas buscan lo que todav√≠a no sos.‚Äù`,
        violeta:`‚ÄúEleg√≠, ROJO: ¬øquer√©s hundirte en la memoria de las ra√≠ces‚Ä¶\no entregarte al v√©rtigo de las ramas?‚Äù`,
        choices:{A:"Ra√≠ces.", B:"Ramas."},
      },
      {
        id:3, title:"üìú Fragmento 3 ‚Äì El Rinc√≥n de la Sabidur√≠a",
        consequence:{
          A:"El suelo sigue temblando en su pecho. Cada libro parece reconocerla, como si ya estuviera marcada por su memoria.",
          B:"El viento de las ramas todav√≠a le eriza la piel. Las p√°ginas se mueven inquietas, como si quisieran mostrarle futuros no vividos."
        },
        history:`Un espacio circular lleno de libros y s√≠mbolos vivos. En el centro, un libro iluminado espera.`,
        verde:`‚ÄúLa sabidur√≠a puede sanar o pesar, ROJO.\nCada palabra escrita es un espejo distinto.‚Äù`,
        violeta:`‚ÄúEleg√≠.\n¬øVas a abrir ese libro prohibido y cargar con lo que revele‚Ä¶\no vas a cerrarlo y avanzar en la oscuridad de la intuici√≥n?‚Äù`,
        choices:{A:"Abrir.", B:"Cerrar."},
      },
      {
        id:4, title:"üï∞Ô∏è Fragmento 4 ‚Äì El Antiguo Carruaje",
        consequence:{
          A:"Las palabras arden en su mente. El carruaje parece una frase interminable, grabada en madera.",
          B:"El silencio del libro cerrado late. El carruaje parece callar con ella, guardando intuiciones nunca dichas."
        },
        history:`El carruaje viejo, gastado, su transporte favorito de otro tiempo. Inm√≥vil, pero lleno de memorias.`,
        verde:`‚ÄúEste carruaje fue viaje, hogar, refugio.\nLo que guardaste en √©l nunca muri√≥.‚Äù`,
        violeta:`‚ÄúDecid√≠.\n¬øSub√≠s para revivir lo que fuiste‚Ä¶\no lo dej√°s abandonado para seguir liviana?‚Äù`,
        choices:{A:"Subir.", B:"Dejar."},
      },
      {
        id:5, title:"üí∞ Fragmento 5 ‚Äì Los Comerciantes",
        consequence:{
          A:"Los recuerdos vividos en el carruaje a√∫n la envuelven. En el mercado, cada frasco parece contenerlos.",
          B:"El silencio del carruaje abandonado pesa. En el mercado, los frascos parecen ofrecer lo que dej√≥ atr√°s."
        },
        history:`Un mercado donde se comercian recuerdos y emociones, guardados en frascos luminosos.`,
        verde:`‚ÄúLos recuerdos son m√°s valiosos que cualquier tesoro.\nDar o tomar cambia lo que sos.‚Äù`,
        violeta:`‚ÄúEleg√≠.\n¬øVas a entregar un recuerdo tuyo‚Ä¶\no cargar con el de un desconocido?‚Äù`,
        choices:{A:"Dar.", B:"Tomar."},
      },
      {
        id:6, title:"üç∑ Fragmento 6 ‚Äì El Mes√≥n",
        consequence:{
          A:"Siente la p√©rdida como un vac√≠o. En el mes√≥n, las risas parecen ocupar ese hueco.",
          B:"Un recuerdo ajeno late en su interior. En el mes√≥n, cree reconocer rostros que nunca conoci√≥."
        },
        history:`Un mes√≥n c√°lido, lleno de voces y nuevas compa√±√≠as que siempre estuvieron ah√≠.`,
        verde:`‚ÄúEsto tambi√©n es amor, ROJO.\nEl pan partido, la mesa compartida.‚Äù`,
        violeta:`‚ÄúEleg√≠.\n¬øTe sent√°s a la mesa a abrirte‚Ä¶\no te qued√°s sola, observando desde lejos?‚Äù`,
        choices:{A:"Sentarse.", B:"Quedarse sola."},
      },
      {
        id:7, title:"üåÑ Fragmento 7 ‚Äì El Mirador",
        consequence:{
          A:"La calidez de las voces la acompa√±a hasta lo alto. Desde el mirador, siente que esas presencias siguen con ella.",
          B:"El murmullo qued√≥ atr√°s. Desde el mirador, la altura intensifica su aislamiento."
        },
        history:`Un mirador elevado desde el que contempla todos sus recuerdos, felices y dolorosos.`,
        verde:`‚ÄúNo huyas de ellos, ROJO.\nCada memoria te empuja hacia adelante.‚Äù`,
        violeta:`‚ÄúDecid√≠.\n¬øVas a abrazar estos recuerdos como fuerza‚Ä¶\no soltarlos en el viento?‚Äù`,
        choices:{A:"Aceptar recuerdos.", B:"Soltar recuerdos."},
      },
      {
        id:8, title:"üõí Fragmento 8 ‚Äì La Tienda de Abarrotes",
        consequence:{
          A:"Acept√≥ cada memoria. En la tienda, lo cotidiano brilla con un valor profundo.",
          B:"Solt√≥ los recuerdos. En la tienda, todo parece ligero, sin pasado, solo presente."
        },
        history:`Una tienda c√°lida, con comida y objetos sencillos. ROJO va all√≠ con amigos a buscar cosas ricas para compartir.`,
        verde:`‚ÄúEl amor tambi√©n est√° en lo simple.\nEn lo peque√±o que sostiene lo inmenso.‚Äù`,
        violeta:`‚ÄúEleg√≠.\n¬øTom√°s lo brillante, lo inmediato‚Ä¶\no lo sencillo, lo que revela su valor cuando se comparte?‚Äù`,
        choices:{A:"Brillante.", B:"Sencillo."},
      },
      {
        id:9, title:"üè° Fragmento 9 ‚Äì Hogar",
        consequence:{
          A:"El objeto brillante todav√≠a pesa en su mano como promesa. Ahora, en el Hogar, ese destello vibra en la mesa de luz, transformado en s√≠mbolo de todo lo que eligi√≥ buscar.",
          B:"El objeto sencillo descansa c√°lido en su mano. En el Hogar, se revela su verdadero valor: lo peque√±o siempre sostuvo lo inmenso."
        },
        history:`El c√≠rculo se cierra. ROJO vuelve al mismo cuarto donde despert√≥ aquella primera vez.\nPero ya no es penumbra indecisa: la habitaci√≥n est√° ba√±ada por una luz c√°lida que se derrama desde la ventana, envolviendo cada rinc√≥n en claridad.\n\nSobre la mesa de luz ya no hay papeles inquietantes ni dibujos que la miran.\nEn su lugar, hay un cuenco con aros de miel y una bolsa abierta de gomitas de colores.\nPeque√±os gestos, sencillos y dulces, que parecen decirle sin palabras: ‚ÄúSiempre hubo un lugar para vos.‚Äù\n\nEl aire mismo respira distinto: no es el silencio pesado del principio, sino el sosiego de saber que alguien la espera, que alguien la nombra incluso cuando no est√°.\nEl Hogar no interrumpe.\nEl Hogar nunca la hace sentir de m√°s.\nEl Hogar celebra cuando llega.\nEl Hogar la extra√±a cuando se va.\nEl Hogar guarda su espacio, incluso en el vac√≠o.`,
        verde:`‚ÄúEste siempre fue tu lugar, ROJO.\nEl amor no ten√≠as que salir a buscarlo: estaba ac√°, esper√°ndote.\nEl Hogar no son paredes ni objetos: es la certeza de que sos amada.\nNo vuelvas a dudar de eso nunca m√°s.‚Äù\n\nPor primera vez, la voz de VIOLETA00 ya no suena cortante ni burlona. Es clara, firme, como un sello que cierra el viaje: ‚ÄúNo hay m√°s elecciones, ROJO. Ya llegaste. Este es el √∫nico sitio donde nunca sobra nada de vos, donde siempre hay espacio para tu risa y tus silencios. Este es tu Hogar. Y siempre lo fue.‚Äù`,
        violeta:`El mareo desaparece. La risa del sue√±o inicial vuelve, pero ya no hiere: ahora acaricia. Cada fragmento vivido ‚Äîel √°rbol, los comerciantes, el carruaje, el mes√≥n, el mirador, la tienda‚Äî se siente como piezas que encajan en un mismo mosaico. Todo ten√≠a un sentido: llevarla hasta ac√°.\n\nPor primera vez, no tiene que elegir.\nNo tiene que correr.\nNo tiene que buscar.\n\nSolo tiene que quedarse.\n\nY lo sabe con una certeza luminosa que arde en su pecho: Amar y dejarse amar no es un destino. Es su Hogar.`,
        choices:null,
      },
    ];

    // =====================
    // Transiciones (texto + enigma + respuestas permitidas)
    // =====================
    const transitions = [
      { id:1,
        text:`El aire de la habitaci√≥n no se disipa. El papel del √°rbol ya no est√°, pero la sensaci√≥n de un secreto oculto permanece. Algo bloquea el camino, como un candado invisible. Dirigite a la Plaza Grigera para continuar.`,
        enigma:`¬øCu√°ntos a√±os tiene la plaza a la que llegaste? La respuesta la vas a encontrar en el lado m√°s religioso.`,
        answers:["204"]
      },
      { id:2,
        text:`El eco de las ra√≠ces todav√≠a vibra en tu pecho. Las ramas parecen extenderse hacia caminos ocultos. Pero algo bloquea la entrada al rinc√≥n donde aguarda la sabidur√≠a. (Dirigite a Yenny y pregunt√° si no hay algo para vos).`,
        enigma:`En el mismo libro que viste, alguien dej√≥ grabado un mensaje oculto. Escribilo para poder avanzar.`,
        answers:["ENANO"] // Se acepta case-insensitive
      },
      { id:3,
        text:`El brillo del libro no desaparece del todo. Aunque lo cerraste o lo abriste, su resplandor sigue latiendo en tu mente. Antes de llegar al carruaje, un candado bloquea el camino. (S√≠, and√° al 147).`,
        enigma:`¬øCu√°l es la patente del carruaje?`,
        answers:["SBU933"]
      },
      { id:4,
        text:`El carruaje se desvanece lentamente, como entregando su √∫ltimo secreto. Antes de llegar al mercado de los Comerciantes, un nuevo candado aparece en el camino. (Busc√° en los puestos de Diario, ah√≠ puede haber una pista para vos).`,
        enigma:`Uno de los frascos del mercado ten√≠a una palabra escrita en una hoja de diario arrugada. Escribila para continuar.`,
        answers:["LEGO"]
      },
      { id:5,
        text:`El mercado se desvanece detr√°s tuyo. Los frascos se apagan como brasas fr√≠as, pero uno todav√≠a late con fuerza. Antes de entrar al Mes√≥n, un candado invisible detiene tus pasos. (Creo que en Starbucks, si te cop√°s invitale algo a tus amigos).`,
        enigma:`Ese √∫ltimo frasco ten√≠a pegado un papel arrugado con un nombre escrito a mano. Escribilo para poder avanzar.`,
        answers:["FRAPUCHINO"]
      },
      { id:6,
        text:`Dej√°s atr√°s el Mes√≥n, con el eco de risas y el sabor dulce del frappuccino todav√≠a en tu memoria. Sent√≠s que el aire se vuelve m√°s liviano al salir, como si necesitara abrirte paso hacia algo m√°s grande. Respir√° hondo. (En la terraza, las palomas dan un mensaje).`,
        enigma:`¬øDe qui√©n es el mensaje de la paloma?`,
        answers:["TOP"]
      },
      { id:7,
        text:`El viento del Mirador sopla fuerte, llevando consigo memorias que parecen flotar y desvanecerse. Desde lo alto, la vista abre un horizonte nuevo, pero un candado invisible te recuerda que todav√≠a queda un paso m√°s antes de bajar hacia la Tienda de Abarrotes. (Te toca ir a Josimar y comprar la cena).`,
        enigma:`¬øCu√°l es el #Hashtag de los Doritos Dinamita?`,
        answers:["PICANTEPERORICO"]
      },
      { id:8,
        text:`La luz de la Tienda de Abarrotes comienza a apagarse. ROJO16 siente el cansancio de tantas vueltas, de cada paso, de cada enigma. En su interior solo late un deseo: volver al Hogar. Pero todav√≠a no sabe cu√°l es, ni c√≥mo encontrarlo. (Espero tengas las zapatillas nuevas puestas).`,
        enigma:`Dentro de tus botas nuevas vas a encontrar el camino de vuelta.`,
        answers:["8A"]
      },
      { id:9,
        text:`El aire se vuelve espeso por un instante. La Tienda ya qued√≥ atr√°s, pero el Hogar todav√≠a no aparece del todo. ROJO16 siente que est√° a un paso, aunque algo invisible bloquea la entrada. Es el candado final, el que guarda los tesoros.`,
        enigma:`¬øQu√© es lo que encontraste cuando volviste una...?`,
        answers:["CAJA"]
      },
    ];

    // =====================
    // Estado y referencias
    // =====================
    let index = 0; // √≠ndice de fragmento 0..8
    let mode = 'fragment'; // 'fragment' | 'transition'
    let choices = []; // 'A' | 'B' por fragmento (1..8)

    const el = {
      title: document.getElementById('title'),
      badge: document.getElementById('badge'),
      consequence: document.getElementById('consequence'),
      history: document.getElementById('history'),
      verde: document.getElementById('verde'),
      violeta: document.getElementById('violeta'),
      verdeSection: document.getElementById('verdeSection'),
      violetaSection: document.getElementById('violetaSection'),
      choices: document.getElementById('choices'),
      bar: document.getElementById('bar'),
      footerHelp: document.getElementById('footerHelp'),
      restart: document.getElementById('restartBtn'),
      save: document.getElementById('saveBtn'),
      load: document.getElementById('loadBtn'),
    };

    function sanitize(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,''); }

    function render(){
      if(!Array.isArray(fragments) || fragments.length === 0){
        el.title.textContent = 'Error: no hay fragmentos cargados';
        el.badge.textContent = '0 / 0';
        el.history.textContent = 'Revis√° la definici√≥n de datos (fragments[])';
        el.verde.textContent = '';
        el.violeta.textContent = '';
        el.choices.innerHTML = '';
        el.consequence.hidden = true;
        el.bar.style.width = '0%';
        return;
      }
      if(index < 0 || index >= fragments.length){ index = 0; }

      if(mode === 'fragment'){
        const frag = fragments[index];
        el.title.textContent = frag.title;
        el.badge.textContent = `${index+1} / ${fragments.length}`;

        // Consecuencia (si no es el primer fragmento)
        if(index>0){
          const prevChoice = choices[index-1];
          const cons = frag.consequence?.[prevChoice];
          if(cons){
            el.consequence.hidden = false;
            el.consequence.innerHTML = `<strong>Consecuencia de tu elecci√≥n:</strong> ${cons}`;
          }else{
            el.consequence.hidden = true;
            el.consequence.textContent = '';
          }
        } else {
          el.consequence.hidden = true;
          el.consequence.textContent = '';
        }

        el.history.textContent = frag.history || '';
        el.verde.textContent = frag.verde || '';
        el.violeta.textContent = frag.violeta || '';

        el.verdeSection.style.display = '';
        el.violetaSection.style.display = '';

        // Botones de elecci√≥n
        el.choices.innerHTML = '';
        if(frag.choices){
          const aBtn = document.createElement('button');
          aBtn.className = 'choice';
          aBtn.textContent = `A ‚Äî ${frag.choices.A}`;
          aBtn.onclick = ()=> choose('A');

          const bBtn = document.createElement('button');
          bBtn.className = 'choice';
          bBtn.textContent = `B ‚Äî ${frag.choices.B}`;
          bBtn.onclick = ()=> choose('B');

          el.choices.appendChild(aBtn);
          el.choices.appendChild(bBtn);
          el.footerHelp.innerHTML = 'Eleg√≠ con los botones o con el teclado: <strong>A</strong>/<strong>B</strong>.';
        } else {
          const end = document.createElement('div');
          end.className = 'narrative';
          end.style.marginTop = '8px';
          end.innerHTML = '<em>Fin del viaje. Pod√©s reiniciar cuando quieras.</em>';
          el.choices.appendChild(end);
          el.footerHelp.textContent = 'Llegaste al final.';
        }

        const progress = (index)/(fragments.length-1) * 100;
        el.bar.style.width = `${progress}%`;
      }
      else if(mode === 'transition'){
        const t = transitions[index < transitions.length ? index : transitions.length - 1]; // trans 1..9, se usa √≠ndice actual
        el.title.textContent = `üîë Transici√≥n ${t.id}`;
        el.badge.textContent = `Candado ${t.id}`;

        // En modo transici√≥n usamos History para el texto y Violeta para el enigma
        el.consequence.hidden = true;
        el.history.textContent = t.text || '';
        el.verde.textContent = '';
        el.violeta.textContent = t.enigma || '';

        el.verdeSection.style.display = 'none';
        el.violetaSection.style.display = '';

        el.choices.innerHTML = '';
        const lockWrap = document.createElement('div');
        lockWrap.className = 'lock';
        lockWrap.innerHTML = `
          <input id="answerInput" type="text" placeholder="Escrib√≠ la respuesta" aria-label="Respuesta del enigma">
          <button id="validateBtn">Validar</button>
          <div class="hint">No distingue may√∫sculas/min√∫sculas. Se ignoran espacios.</div>
        `;
        el.choices.appendChild(lockWrap);

        const input = lockWrap.querySelector('#answerInput');
        const btn = lockWrap.querySelector('#validateBtn');
        input.focus();

        const tryValidate = ()=>{
          const val = sanitize(input.value);
          const ok = (t.answers||[]).some(a => sanitize(a) === val);
          if(ok){
            // Avanzar
            mode = 'fragment';
            // Si esta es la transici√≥n 9 (antes del fragmento 9), pasamos a frag 9
            index = Math.min(index+1, fragments.length-1);
            saveSession();
            render();
            window.scrollTo({top:0, behavior:'smooth'});
          } else {
            input.setCustomValidity('Respuesta incorrecta');
            input.reportValidity();
            setTimeout(()=>{ input.setCustomValidity(''); }, 1200);
          }
        };

        btn.onclick = tryValidate;
        input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryValidate(); });

        el.footerHelp.textContent = 'Escrib√≠ la respuesta del enigma para desbloquear.';

        // La barra de progreso no avanza en transici√≥n
        const progress = (index)/(fragments.length-1) * 100;
        el.bar.style.width = `${progress}%`;
      }
    }

    function choose(letter){
      choices[index] = letter;
      // Luego de elegir en un fragmento (excepto el 9, que no tiene), vamos a la transici√≥n correspondiente
      if(index < fragments.length-1){
        mode = 'transition';
        saveSession();
        render();
        window.scrollTo({top:0, behavior:'smooth'});
      } else {
        // Fragmento final
        saveSession();
      }
    }

    window.addEventListener('keydown', (e)=>{
      if(mode !== 'fragment') return;
      if(['a','A'].includes(e.key)){
        const frag = fragments[index];
        if(frag && frag.choices) choose('A');
      }
      if(['b','B'].includes(e.key)){
        const frag = fragments[index];
        if(frag && frag.choices) choose('B');
      }
    });

    function saveSession(){
      try{
        localStorage.setItem('rojo16_index', String(index));
        localStorage.setItem('rojo16_mode', mode);
        localStorage.setItem('rojo16_choices', JSON.stringify(choices));
      }catch{}
    }

    function loadSession(){
      try{
        const i = parseInt(localStorage.getItem('rojo16_index')||'0',10);
        const m = localStorage.getItem('rojo16_mode')||'fragment';
        const c = JSON.parse(localStorage.getItem('rojo16_choices')||'[]');
        if(!Number.isNaN(i) && i>=0 && i<fragments.length){ index=i; }
        mode = (m === 'transition' || m === 'fragment') ? m : 'fragment';
        if(Array.isArray(c)) choices=c; else choices=[];
      }catch{}
      render();
    }

    document.getElementById('restartBtn').onclick = ()=>{ index = 0; choices = []; mode = 'fragment'; render(); saveSession(); window.scrollTo({top:0,behavior:'smooth'}); };
    document.getElementById('saveBtn').onclick = ()=>{ saveSession(); document.getElementById('saveBtn').textContent='Guardado'; setTimeout(()=> document.getElementById('saveBtn').textContent='Guardar', 1200)};
    document.getElementById('loadBtn').onclick = ()=>{ loadSession(); document.getElementById('loadBtn').textContent='Cargado'; setTimeout(()=> document.getElementById('loadBtn').textContent='Cargar', 1200)};

    // Cargar sesi√≥n o iniciar
    loadSession();
  </script>
</body>
</html>
