<!DOCTYPE html><html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>El Viaje de ROJO16 ‚Äî Web Interactiva</title>
  <style>
    :root{
      --bg:#0b0b12; --fg:#e9e9ef; --muted:#babacc; --accent:#ff415d; --panel:#141423; --verde:#8fe388; --violeta:#b18ae6;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji',sans-serif; background:radial-gradient(1200px 800px at 20% -10%,#1d1d32,transparent),linear-gradient(180deg,#0b0b12 0%, #090910 100%); color:var(--fg); font-size:17px; line-height:1.6}
    header{position:sticky; top:0; z-index:10; backdrop-filter: blur(8px); background:rgba(9,9,16,.6); border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:900px; margin:0 auto; padding:16px 20px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:32px; height:32px; border-radius:12px; background:conic-gradient(from 180deg, var(--accent), #ff7a7a, #ffa3a3, var(--accent)); box-shadow:var(--shadow)}
    .brand h1{font-size:18px; margin:0; letter-spacing:.3px}
    main{padding:28px 20px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:var(--shadow); overflow:hidden}
    .card .inner{padding:24px}
    .title{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .title h2{margin:0; font-weight:700; font-size:22px}
    .badge{font-size:12px; color:var(--muted); background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px}

    .consequence{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); padding:14px 16px; border-radius:14px; margin:16px 0}
    .consequence strong{color:var(--muted)}

    .section{margin:16px 0}
    .section h3{margin:.2rem 0 .5rem; font-size:14px; color:var(--muted); font-weight:600; letter-spacing:.4px; text-transform:uppercase}
    .narrative{line-height:1.7; font-size:16px}

    .voice-verde{color:var(--verde); font-style:italic}
    .voice-violeta{color:var(--violeta); font-style:italic}

    .choices{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px}
    button.choice{padding:16px; min-height:48px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03); color:var(--fg); cursor:pointer; transition:.2s transform ease, .2s background-color ease, .2s border-color ease; font-weight:600; font-size:17px}
    button.choice:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    button.choice:active{transform:translateY(0)}

    .footer{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; color:var(--muted); font-size:13px; flex-wrap:wrap}

    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .controls button{padding:12px 14px; min-height:44px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.02); color:var(--fg); cursor:pointer; font-size:15px}

    .progress{height:8px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; margin:12px 0 0}
    .progress > div{height:100%; background:linear-gradient(90deg, var(--accent), #ff7a7a); width:0%}

    /* Transition UI */
    .lock{display:grid; gap:12px; margin-top:16px}
    .lock input{padding:14px; min-height:48px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03); color:var(--fg); width:100%; font-size:17px}
    .lock button{padding:14px; min-height:48px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:var(--accent); color:#111; font-weight:700; cursor:pointer; font-size:17px}
    .hint{font-size:12px; color:var(--muted)}

    @media (max-width:640px){ .choices{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>El Viaje de ROJO16 ‚Äî Interactivo</h1>
    </div>
  </header>
  <main class="wrap">
    <div class="card" role="region" aria-live="polite">
      <div class="inner">
        <div class="title">
          <h2 id="title">Fragmento</h2>
          <span class="badge" id="badge">1 / 9</span>
        </div>
        <div id="consequence" class="consequence" hidden></div>

        <div class="section" id="historySection">
          <h3>Historia</h3>
          <p id="history" class="narrative"></p>
        </div>
        <div class="section" id="verdeSection">
          <h3>VERDE</h3>
          <p id="verde" class="narrative voice-verde"></p>
        </div>
        <div class="section" id="violetaSection">
          <h3>VIOLETA</h3>
          <p id="violeta" class="narrative voice-violeta"></p>
        </div>

        <div id="choices" class="choices"></div>

        <div class="footer">
          <div id="footerHelp">Eleg√≠ con los botones o con el teclado: <strong>A</strong>/<strong>B</strong>.</div>
          <div class="controls">
            <button id="restartBtn" title="Reiniciar">Reiniciar</button>
            <button id="saveBtn" title="Guardar progreso">Guardar</button>
            <button id="loadBtn" title="Cargar progreso">Cargar</button>
          </div>
        </div>
        <div class="progress" aria-hidden="true"><div id="bar"></div></div>
      </div>
    </div>
  </main>

  <script>
    // Vibraci√≥n h√°ptica (si disponible)
    function vibrate(pattern){ if(navigator.vibrate){ navigator.vibrate(pattern); } }
    function sanitize(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,''); }

    // =====================
    // Fragmentos (versi√≥n extendida)
    // =====================
    const fragments = [
      {
        id:1, title:"üåë Fragmento 1 ‚Äì El Despertar",
        history:`ROJO16 se despert√≥ sobresaltada. El amanecer apenas entraba por la ventana y la habitaci√≥n estaba cubierta por una penumbra suave, esa luz indecisa que no es de noche ni de d√≠a. La sensaci√≥n era clara: hab√≠a so√±ado algo importante‚Ä¶ pero el recuerdo se disolv√≠a como agua entre los dedos. No quedaba imagen precisa, solo un eco. Una risa. Y detr√°s de esa risa, la silueta de un √°rbol tan alto que parec√≠a rozar el cielo. El coraz√≥n le lat√≠a con fuerza, como si hubiera estado corriendo dentro de ese sue√±o, o como si lo que hab√≠a vivido all√≠ no fuese del todo un sue√±o. Gir√≥ la cabeza. Sobre la mesa de luz hab√≠a un papel doblado en cuatro. No recordaba haberlo dejado all√≠ la noche anterior. Dud√≥ en tocarlo; la habitaci√≥n entera parec√≠a esperar junto a ella, en un silencio extra√±o. Lo abri√≥ con cuidado. Dentro, apenas con unas l√≠neas torpes de tinta oscura, hab√≠a un dibujo: un √°rbol solitario. Pero la copa no estaba hecha de hojas, sino de una espiral que se extend√≠a hacia afuera, como si tratara de escapar del papel. El trazo parec√≠a vibrar bajo la luz, y por un instante, ROJO16 tuvo la certeza de que el dibujo la estaba observando. Un mareo la oblig√≥ a cerrar los ojos. Y en ese instante breve, la risa volvi√≥, acompa√±ada de un murmullo que no proven√≠a de su mente ni de la habitaci√≥n.`,
        verde:`‚ÄúDespertar no siempre es abrir los ojos, ROJO. Es escuchar lo que todav√≠a late en vos. Ese papel no es un dibujo: es un espejo. El √°rbol est√° esperando que decidas si volver a recordarlo‚Ä¶ o si vas a seguir corriendo de lo que fuiste.‚Äù`,
        violeta:`‚ÄúEleg√≠, ROJO. ¬øVas a hundirte en la espiral hacia adentro, reclamando lo que perdiste‚Ä¶ o vas a dejar que la espiral te arrastre hacia afuera, donde nada te pertenece todav√≠a?‚Äù`,
        choices:{A:"Seguir la espiral hacia adentro ‚Üí enfrentar los recuerdos.", B:"Seguir la espiral hacia afuera ‚Üí entregarse a lo desconocido."},
      },
      {
        id:2, title:"üå≥ Fragmento 2 ‚Äì El √Årbol",
        consequence:{ A:"El peso de la espiral la acompa√±a. El √°rbol aparece frente a ella como un recuerdo que nunca muri√≥.", B:"El v√©rtigo de la espiral a√∫n la sacude. El √°rbol surge ahora como una promesa de lo que todav√≠a no existe." },
        history:`Frente a ella, el √°rbol inmenso. Sus ra√≠ces se hunden como venas negras y sus ramas giran en espiral hacia el cielo. El aire vibra, como si respirara. El suelo parece tener memoria: cada paso resuena como si despertara voces antiguas.`,
        verde:`‚ÄúLa memoria y el deseo est√°n en un mismo cuerpo, ROJO. Las ra√≠ces sostienen lo que fuiste. Las ramas buscan lo que todav√≠a no sos.‚Äù`,
        violeta:`‚ÄúEleg√≠, ROJO: ¬øquer√©s hundirte en la memoria de las ra√≠ces‚Ä¶ o entregarte al v√©rtigo de las ramas?‚Äù`,
        choices:{A:"Ra√≠ces.", B:"Ramas."},
      },
      {
        id:3, title:"üìú Fragmento 3 ‚Äì El Rinc√≥n de la Sabidur√≠a",
        consequence:{ A:"El suelo sigue temblando en su pecho. Cada libro parece reconocerla, como si ya estuviera marcada por su memoria.", B:"El viento de las ramas todav√≠a le eriza la piel. Las p√°ginas se mueven inquietas, como si quisieran mostrarle futuros no vividos." },
        history:`Una sala circular la recibe, como si hubiera entrado a un santuario olvidado. Las paredes est√°n cubiertas de s√≠mbolos que cambian de forma al mirarlos. Los estantes, infinitos, sostienen libros sin t√≠tulo; algunos encadenados, otros palpitando como si respiraran. En el centro, un atril sostiene un libro abierto que brilla con una luz azulada, como si ardiera en silencio. El aire huele a polvo antiguo y a revelaci√≥n contenida.`,
        verde:`‚ÄúLa sabidur√≠a puede sanar o pesar, ROJO. Cada palabra escrita es un espejo distinto.‚Äù`,
        violeta:`‚ÄúEleg√≠. ¬øVas a abrir ese libro prohibido y cargar con lo que revele‚Ä¶ o vas a cerrarlo y avanzar en la oscuridad de la intuici√≥n?‚Äù`,
        choices:{A:"Abrir.", B:"Cerrar."},
      },
      {
        id:4, title:"üï∞Ô∏è Fragmento 4 ‚Äì El Antiguo Carruaje",
        consequence:{ A:"Las palabras arden en su mente. El carruaje parece una frase interminable, grabada en madera.", B:"El silencio del libro cerrado late. El carruaje parece callar con ella, guardando intuiciones nunca dichas." },
        history:`En un descampado silencioso, espera un carruaje antiguo. La madera est√° gastada y agrietada, con la pintura descascarada por los a√±os. Las ruedas, hundidas en el barro seco, parecen clavadas en el tiempo. Las cortinas deshilachadas se mueven con el viento como si a√∫n guardaran secretos. Al verlo, ROJO16 siente que algo se abre en su memoria. No es solo un carruaje: es un cofre vivo. Recuerda las risas de los amigos que ya no est√°n, las charlas interminables bajo la noche, las canciones improvisadas mientras el traqueteo marcaba el comp√°s. Cada golpe de madera contra el camino fue una alegr√≠a guardada, cada viaje una chispa que ilumin√≥ un instante de su vida. El carruaje est√° inm√≥vil, pero en su interior laten todos los momentos que la acompa√±aron alguna vez. Es refugio y despedida, un recordatorio de lo que fue amado y compartido.`,
        verde:`‚ÄúEste carruaje fue viaje, hogar, refugio. Lo que guardaste en √©l nunca muri√≥.‚Äù`,
        violeta:`‚ÄúDecid√≠. ¬øSub√≠s para revivir lo que fuiste‚Ä¶ o lo dej√°s abandonado para seguir liviana?‚Äù`,
        choices:{A:"Subir.", B:"Dejar."},
      },
      {
        id:5, title:"üí∞ Fragmento 5 ‚Äì Los Comerciantes",
        consequence:{ A:"Los recuerdos vividos en el carruaje a√∫n la envuelven. En el mercado, cada frasco parece contenerlos.", B:"El silencio del carruaje abandonado pesa. En el mercado, los frascos parecen ofrecer lo que dej√≥ atr√°s." },
        history:`Un mercado extra√±o se abre ante ella. Los puestos no venden frutas ni telas, sino frascos luminosos que palpitan como corazones. Cada etiqueta torcida tiene nombres imposibles: ‚ÄúRisa de infancia‚Äù, ‚ÄúUn abrazo perdido‚Äù, ‚ÄúEl √∫ltimo adi√≥s‚Äù. Los comerciantes observan en silencio, como si supieran qu√© recuerdo le falta y cu√°l est√° dispuesta a entregar.`,
        verde:`‚ÄúLos recuerdos son m√°s valiosos que cualquier tesoro. Dar o tomar cambia lo que sos.‚Äù`,
        violeta:`‚ÄúEleg√≠. ¬øVas a entregar un recuerdo tuyo‚Ä¶ o cargar con el de un desconocido?‚Äù`,
        choices:{A:"Dar.", B:"Tomar."},
      },
      {
        id:6, title:"üç∑ Fragmento 6 ‚Äì El Mes√≥n",
        consequence:{ A:"Siente la p√©rdida como un vac√≠o. En el mes√≥n, las risas parecen ocupar ese hueco.", B:"Un recuerdo ajeno late en su interior. En el mes√≥n, cree reconocer rostros que nunca conoci√≥." },
        history:`La puerta del mes√≥n se abre con un chirrido suave, y un aire c√°lido la envuelve de inmediato. El interior huele a pan reci√©n horneado, caf√© y le√±a encendida. Sobre largas mesas de madera, gente conversa animadamente, compartiendo platos abundantes que parecen no agotarse nunca. Cada rostro cambia cuando parpadea: a veces son desconocidos, otras veces parecen antiguos compa√±eros, incluso alguien que jurar√≠a haber visto en un recuerdo ajeno. Las velas iluminan la sala con una luz temblorosa, como si el lugar mismo respirara. ROJO16 siente que all√≠ hay un refugio: un espacio donde nadie pregunta de d√≥nde viene ni a d√≥nde va, solo la invitan a sentarse y ser parte de la mesa.`,
        verde:`‚ÄúEsto tambi√©n es amor, ROJO. El pan partido, la mesa compartida.‚Äù`,
        violeta:`‚ÄúEleg√≠. ¬øTe sent√°s a la mesa a abrirte‚Ä¶ o te qued√°s sola, observando desde lejos?‚Äù`,
        choices:{A:"Sentarse.", B:"Quedarse sola."},
      },
      {
        id:7, title:"üåÑ Fragmento 7 ‚Äì El Mirador",
        consequence:{ A:"La calidez de las voces la acompa√±a hasta lo alto. Desde el mirador, siente que esas presencias siguen con ella.", B:"El murmullo qued√≥ atr√°s. Desde el mirador, la altura intensifica su aislamiento." },
        history:`ROJO16 asciende hasta un mirador de piedra. El viento sopla fuerte, llevando retazos de voces, carcajadas y silencios que parecen pertenecer tanto a su vida como a otras que nunca vivi√≥. Desde lo alto, el paisaje se vuelve imposible: mares suspendidos en el cielo que quiebran en olas lentas, monta√±as que laten como corazones gigantes, nubes con un resplandor l√≠quido. El horizonte no ofrece un solo mundo, sino varios entrelazados, como si cada recuerdo fuera una ventana distinta. En medio de esa inmensidad, ROJO16 entiende que lo que ve no est√° afuera: lo ve a trav√©s de lo que lleva adentro.`,
        verde:`‚ÄúNo huyas de ellos, ROJO. Cada memoria te empuja hacia adelante.‚Äù`,
        violeta:`‚ÄúDecid√≠. ¬øVas a abrazar estos recuerdos como fuerza‚Ä¶ o soltarlos en el viento?‚Äù`,
        choices:{A:"Aceptar recuerdos.", B:"Soltar recuerdos."},
      },
      {
        id:8, title:"üõí Fragmento 8 ‚Äì La Tienda de Abarrotes",
        consequence:{ A:"Acept√≥ cada memoria. En la tienda, lo cotidiano brilla con un valor profundo.", B:"Solt√≥ los recuerdos. En la tienda, todo parece ligero, sin pasado, solo presente." },
        history:`La puerta de la tienda se abre y el aire tibio la envuelve. Los estantes est√°n repletos de cosas simples y tentadoras: panes dulces, frutas frescas, frascos de miel, quesos, caf√© reci√©n molido. Todo parece dispuesto para el disfrute y la compa√±√≠a, como si fuera un lugar hecho para que cada visitante encontrara lo que m√°s le gusta y pudiera compartirlo con otros. ROJO16 recorre los pasillos con las manos rozando los objetos, pero en el fondo de su pecho late un vac√≠o extra√±o. No sabe de d√≥nde viene ni hacia d√≥nde va. Aunque la tienda est√° llena de todo lo que podr√≠a darle calor y cercan√≠a, ella se sigue sintiendo sola, como si nada de eso alcanzara para responder qui√©n es.`,
        verde:`‚ÄúEl amor tambi√©n est√° en lo simple. En lo peque√±o que sostiene lo inmenso.‚Äù`,
        violeta:`‚ÄúEleg√≠, ROJO. ¬øSal√≠s con las manos llenas‚Ä¶ o con las manos vac√≠as para que te las llenen?‚Äù`,
        choices:{A:"Manos llenas.", B:"Manos vac√≠as."},
      },
      {
        id:9, title:"üè° Fragmento 9 ‚Äì Hogar",
        consequence:{
          A:"Las manos de ROJO pesan todav√≠a con lo que eligi√≥ cargar. Al llegar al Hogar, descubre que aquello que sosten√≠a ahora brilla sobre la cama, convertido en s√≠mbolo de todo lo que busc√≥.",
          B:"ROJO llega al Hogar con las manos vac√≠as. Pero all√≠, sobre la cama, entiende que ese vac√≠o es espacio abierto: lugar para recibir lo inesperado, para dejar que otros la llenen de amor."
        },
        history:`El c√≠rculo se cierra. ROJO vuelve al mismo cuarto donde despert√≥ aquella primera vez. Pero ya no es penumbra indecisa: la habitaci√≥n est√° ba√±ada por una luz c√°lida que se derrama desde la ventana, envolviendo cada rinc√≥n en claridad.\n\nSobre la cama encontr√≥ un regalo que no se esperaba. Peque√±os gestos, sencillos y dulces, que parecen decirle sin palabras: ‚ÄúSiempre hubo un lugar para vos.‚Äù\n\nEl aire mismo respira distinto: no es el silencio pesado del principio, sino el sosiego de saber que alguien la espera, que alguien la nombra incluso cuando no est√°. El Hogar no interrumpe. El Hogar nunca la hace sentir de m√°s. El Hogar celebra cuando llega. El Hogar la extra√±a cuando se va. El Hogar guarda su espacio, incluso en el vac√≠o.`,
        verde:`‚ÄúEste siempre fue tu lugar, ROJO. El amor no ten√≠as que salir a buscarlo: estaba ac√°, esper√°ndote. El Hogar no son paredes ni objetos: es la certeza de que sos amada. No vuelvas a dudar de eso nunca m√°s.‚Äù`,
        violeta:`‚ÄúNo hay m√°s elecciones, ROJO. Ya llegaste. Este es el √∫nico sitio donde nunca sobra nada de vos, donde siempre hay espacio para tu risa y tus silencios. Este es tu Hogar. Y siempre lo fue.‚Äù`,
        choices:null,
      },
    ];

    // =====================
    // Transiciones (ajustadas)
    // =====================
    const transitions = [
      { id:1,
        text:`El aire de la habitaci√≥n no se disipa. El papel del √°rbol ya no est√°, pero la sensaci√≥n de un secreto oculto permanece. Algo bloquea el camino, como un candado invisible. Dirigite a la Plaza Grigera para continuar.`,
        enigma:`¬øCu√°ntos a√±os tiene la plaza a la que llegaste? La respuesta la vas a encontrar en el lado m√°s religioso.`,
        answers:["204"]
      },
      { id:2,
        text:`El eco de las ra√≠ces todav√≠a vibra en tu pecho. Las ramas parecen extenderse hacia caminos ocultos. Pero algo bloquea la entrada al rinc√≥n donde aguarda la sabidur√≠a. (Dirigite a Yenny y pregunt√° si no hay algo para vos).`,
        enigma:`Hay textos que no se leen en soledad: marcan el alma y se vuelven regalo, algo que se comparte y se da a los dem√°s.\nDecime el nombre del autor de los textos.`,
        answers:["Albert","Espinosa","Albert Espinosa"]
      },
      { id:3,
        text:`El resplandor del libro sigue ardiendo en tu interior, aunque lo hayas abierto o cerrado.\nNo pod√©s desprenderte de esa marca: cada palabra, incluso el silencio, te acompa√±a ahora como un peso.\n\nLos textos te recordaron memoria de viajes del pasado, y te hace recordar tu carruaje...\n(S√≠, hay que ir al 147 üòÇ).`,
        enigma:`¬øCu√°l es la patente del carruaje?`,
        answers:["SBU933"]
      },
      { id:4,
        text:`El carruaje se desvanece lentamente, como entregando su √∫ltimo secreto. Antes de llegar al mercado de los Comerciantes, un nuevo candado aparece en el camino. (Busc√° en los puestos de Diario, ah√≠ puede haber una pista para vos).`,
        enigma:`Uno de los frascos del mercado ten√≠a una palabra escrita en una hoja de diario arrugada. Escribila para continuar.`,
        answers:["LEGO"]
      },
      { id:5,
        text:`El mercado se desvanece detr√°s tuyo.\nLos frascos se apagan como brasas fr√≠as, y con ellos la sensaci√≥n de lo que diste o lo que cargaste.\nEl cuerpo empieza a pesar, y el alma tambi√©n: despu√©s de tanto intercambio, necesit√°s reponer energ√≠as.\n\nROJO recuerda un lugar donde suele ir a reponer energ√≠as.\n(Quiz√°s en Starbucks puedas encontrar lo que necesit√°s, si te cop√°s le compr√°s algo a tus amigos).`,
        enigma:`Ese √∫ltimo frasco ten√≠a pegado un papel arrugado con un nombre escrito a mano. Escribilo para poder avanzar.`,
        answers:["Frappuccino","Frappuchino","Frapuccino"]
      },
      { id:6,
        text:`Dej√°s atr√°s el Mes√≥n con el eco de voces, el aroma del caf√© y el pan a√∫n tibio en tu memoria.\nEl cuerpo se siente m√°s liviano, como si la comida compartida te hubiera devuelto algo m√°s que fuerzas: una certeza de compa√±√≠a.\n\nRespir√°s hondo. El aire afuera parece abrirse ante vos, empuj√°ndote hacia lo que viene.\n(En la terraza, las palomas esperan con un mensaje).`,
        enigma:`¬øDe qui√©n es el mensaje de la paloma?`,
        answers:["TOP","Twenty One Pilots","21 pilots","21 pilotos","Midwest Indigo","Tyler Joseph","Josh Dun"]
      },
      { id:7,
        text:`El viento del Mirador sopla fuerte, llevando consigo memorias que parecen flotar y desvanecerse. Desde lo alto, la vista abre un horizonte nuevo, pero un candado invisible te recuerda que todav√≠a queda un paso m√°s antes de bajar hacia la Tienda de Abarrotes. (Te toca ir a Josimar y comprar la cena).`,
        enigma:`¬øCu√°l es el #Hashtag de los Doritos Dinamita?`,
        answers:["PICANTEPERORICO"]
      },
      { id:8,
        text:`La luz de la Tienda de Abarrotes comienza a apagarse.\nROJO16 camina con el eco de su elecci√≥n a√∫n fresco: manos llenas que pesan, o manos vac√≠as que esperan ser colmadas.\n\nEl cansancio de tantas vueltas se mezcla con un √∫nico deseo: encontrar el Hogar.\nPero todav√≠a no sabe cu√°l es, ni c√≥mo hallarlo.\n(Espero tengas las zapatillas nuevas puestas).`,
        enigma:`Dentro de tus botas nuevas vas a encontrar el camino de vuelta.`,
        answers:["8A"]
      },
      { id:9,
        text:`ROJO cruza el umbral y entra al Hogar.\nLa luz c√°lida la envuelve, y sobre la cama descansan los regalos que nunca se fueron, que siempre la esperaron aunque tardaran en llegar.\n\nSe sienta, los abre uno por uno, y descubre que cada detalle guarda m√°s que recuerdos:\nen su interior hay una palabra, un secreto que la conecta con todo lo vivido.\n\nEse es el candado final. Solo al nombrarla podr√° descansar en paz en su Hogar.`,
        enigma:`Revis√° los regalos que recibiste.\nDecime la palabra que encontraste adentro.`,
        answers:["Bicibanditos"]
      },
    ];

    // =====================
    // Cierre √âpico (se muestra tras la Transici√≥n 9 correcta)
    // =====================
    const EPIC_CLOSE = `El aire se aquieta. El mareo que la hab√≠a perseguido desde el principio se desvanece por completo.\nLa risa del sue√±o inicial regresa, pero ahora suena distinta: c√°lida, cercana, como una caricia que envuelve.\n\nSobre la cama, los regalos que abri√≥ ya no parecen simples objetos: son recuerdos convertidos en detalles, pruebas de que nunca fue olvidada. Siempre estuvieron ah√≠, esper√°ndola, incluso cuando ella no pod√≠a verlos. Tardaron en llegar a sus manos, s√≠, pero jam√°s dejaron de habitar los corazones de quienes la aman.\n\n**VERDE111** susurra con ternura:\n‚ÄúTe esperamos siempre, ROJO.\nAunque tardes, aunque dudes, aunque te pierdas.\nNunca dejamos de guardar tu lugar.‚Äù\n\nY por primera vez, **VIOLETA00** no habla con dureza. Su voz es clara y firme, como un abrazo inesperado:\n‚ÄúSab√≠amos que ibas a volver.\nPod√©s tardar lo que quieras: ac√° siempre vas a encontrarnos.\nNunca olvidamos qui√©n sos, ni lo que llev√°s adentro.‚Äù\n\nLos regalos brillan con un fulgor suave, como si confirmaran lo dicho. Y ROJO entiende, al fin, que el Hogar no es un sitio al que se llega: es la certeza de que, sin importar la distancia o el tiempo, siempre hay alguien esper√°ndola.\n\n**Amar y dejarse amar no es un destino.\nEs su Hogar.**`;

    // =====================
    // Estado y render
    // =====================
    let index = 0;            // √≠ndice de fragmento 0..8
    let mode = 'fragment';    // 'fragment' | 'transition' | 'final'
    let choices = [];         // 'A' | 'B' por fragmento (1..8)

    const el = {
      title: document.getElementById('title'),
      badge: document.getElementById('badge'),
      consequence: document.getElementById('consequence'),
      history: document.getElementById('history'),
      verde: document.getElementById('verde'),
      violeta: document.getElementById('violeta'),
      verdeSection: document.getElementById('verdeSection'),
      violetaSection: document.getElementById('violetaSection'),
      historySection: document.getElementById('historySection'),
      choices: document.getElementById('choices'),
      bar: document.getElementById('bar'),
      footerHelp: document.getElementById('footerHelp'),
      restart: document.getElementById('restartBtn'),
      save: document.getElementById('saveBtn'),
      load: document.getElementById('loadBtn'),
    };

    function render(){
      if(mode === 'fragment'){
        if(index < 0 || index >= fragments.length){ index = 0; }
        const frag = fragments[index];
        el.title.textContent = frag.title;
        el.badge.textContent = `${index+1} / ${fragments.length}`;

        // Consecuencia
        if(index>0){
          const prevChoice = choices[index-1];
          const cons = frag.consequence?.[prevChoice];
          if(cons){ el.consequence.hidden = false; el.consequence.innerHTML = `<strong>Consecuencia de tu elecci√≥n:</strong> ${cons}`; }
          else { el.consequence.hidden = true; el.consequence.textContent = ''; }
        } else { el.consequence.hidden = true; el.consequence.textContent = ''; }

        el.history.textContent = frag.history || '';
        el.verde.textContent = frag.verde || '';
        el.violeta.textContent = frag.violeta || '';

        el.verdeSection.style.display = frag.verde ? '' : 'none';
        el.violetaSection.style.display = frag.violeta ? '' : 'none';
        el.historySection.style.display = '';

        // Botones de elecci√≥n / acci√≥n final
        el.choices.innerHTML = '';
        if(frag.choices){
          const aBtn = document.createElement('button');
          aBtn.className = 'choice';
          aBtn.textContent = `A ‚Äî ${frag.choices.A}`;
          aBtn.onclick = ()=> choose('A');

          const bBtn = document.createElement('button');
          bBtn.className = 'choice';
          bBtn.textContent = `B ‚Äî ${frag.choices.B}`;
          bBtn.onclick = ()=> choose('B');

          el.choices.appendChild(aBtn);
          el.choices.appendChild(bBtn);
          el.footerHelp.innerHTML = 'Eleg√≠ con los botones o con el teclado: <strong>A</strong>/<strong>B</strong>.';
        } else {
          // Fragmento 9 no tiene elecciones -> bot√≥n para Candado Final
          const toFinalLock = document.createElement('button');
          toFinalLock.className = 'choice';
          toFinalLock.textContent = 'üîí Candado final';
          toFinalLock.onclick = ()=> { mode = 'transition'; render(); vibrate([20,40,20]); };
          el.choices.appendChild(toFinalLock);
          el.footerHelp.textContent = 'Abr√≠ el candado final para cerrar el viaje.';
        }

        const progress = (index)/(fragments.length-1) * 100;
        el.bar.style.width = `${progress}%`;
      }
      else if(mode === 'transition'){
        // tIndex: transici√≥n correspondiente al fragmento actual (1‚Üí1, 2‚Üí2, ... 9‚Üí9)
        const tIndex = (index < transitions.length) ? index : transitions.length - 1;
        const t = transitions[tIndex];
        el.title.textContent = `üîë Transici√≥n ${t.id}`;
        el.badge.textContent = `Candado ${t.id}`;

        el.consequence.hidden = true;
        el.history.textContent = t.text || '';
        el.verde.textContent = '';
        el.violeta.textContent = t.enigma || '';

        el.verdeSection.style.display = 'none';
        el.violetaSection.style.display = '';
        el.historySection.style.display = '';

        el.choices.innerHTML = '';
        const lockWrap = document.createElement('div');
        lockWrap.className = 'lock';
        lockWrap.innerHTML = `
          <input id=\"answerInput\" type=\"text\" inputmode=\"text\" autocomplete=\"off\" placeholder=\"Escrib√≠ la respuesta\" aria-label=\"Respuesta del enigma\">\n          <button id=\"validateBtn\">Validar</button>\n          <div class=\"hint\">No distingue may√∫sculas/min√∫sculas. Se ignoran espacios.</div>`;
        el.choices.appendChild(lockWrap);

        const input = lockWrap.querySelector('#answerInput');
        const btn = lockWrap.querySelector('#validateBtn');
        input.focus();

        const tryValidate = ()=>{
          const val = sanitize(input.value);
          const ok = (t.answers||[]).some(a => sanitize(a) === val);
          if(ok){
            vibrate([30,50,30]);
            if(index < fragments.length-1){
              mode = 'fragment';
              index = Math.min(index+1, fragments.length-1);
            } else {
              mode = 'final';
            }
            saveSession();
            render();
            window.scrollTo({top:0, behavior:'smooth'});
          } else {
            vibrate(150);
            input.setCustomValidity('Respuesta incorrecta');
            input.reportValidity();
            setTimeout(()=>{ input.setCustomValidity(''); }, 1200);
          }
        };

        btn.onclick = tryValidate;
        input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryValidate(); });

        el.footerHelp.textContent = 'Escrib√≠ la respuesta del enigma para desbloquear.';
        const progress = (index)/(fragments.length-1) * 100;
        el.bar.style.width = `${progress}%`;
      }
      else if(mode === 'final'){
        el.title.textContent = '‚ú® Cierre √âpico';
        el.badge.textContent = 'Final';
        el.consequence.hidden = true;
        el.historySection.style.display = '';
        el.verdeSection.style.display = 'none';
        el.violetaSection.style.display = 'none';
        el.history.innerHTML = EPIC_CLOSE
          .split('\n')
          .map(p=> p.startsWith('**') ? `<p class=\"narrative\"><strong>${p.replace(/\*\*/g,'')}</strong></p>` : `<p class=\"narrative\">${p}</p>`)
          .join('');
        el.choices.innerHTML = '';
        const end = document.createElement('div');
        end.className = 'narrative';
        end.style.marginTop = '8px';
        end.innerHTML = '<em>Fin del viaje. Pod√©s reiniciar cuando quieras.</em>';
        el.choices.appendChild(end);
        el.footerHelp.textContent = 'Gracias por jugar.';
        el.bar.style.width = '100%';
      }
    }

    function choose(letter){
      vibrate(40);
      choices[index] = letter;
      // tras elegir en un fragmento, pasamos a su transici√≥n correspondiente
      mode = 'transition';
      saveSession();
      render();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    window.addEventListener('keydown', (e)=>{
      if(mode !== 'fragment') return;
      if(['a','A'].includes(e.key)){
        const frag = fragments[index];
        if(frag && frag.choices) choose('A');
      }
      if(['b','B'].includes(e.key)){
        const frag = fragments[index];
        if(frag && frag.choices) choose('B');
      }
    });

    function saveSession(){
      try{
        localStorage.setItem('rojo16_index', String(index));
        localStorage.setItem('rojo16_mode', mode);
        localStorage.setItem('rojo16_choices', JSON.stringify(choices));
      }catch{}
    }

    function loadSession(){
      try{
        const i = parseInt(localStorage.getItem('rojo16_index')||'0',10);
        const m = localStorage.getItem('rojo16_mode')||'fragment';
        const c = JSON.parse(localStorage.getItem('rojo16_choices')||'[]');
        if(!Number.isNaN(i) && i>=0 && i<fragments.length){ index=i; }
        mode = (m === 'transition' || m === 'fragment' || m === 'final') ? m : 'fragment';
        if(Array.isArray(c)) choices=c; else choices=[];
      }catch{}
      render();
    }

    document.getElementById('restartBtn').onclick = ()=>{ index = 0; choices = []; mode = 'fragment'; render(); saveSession(); window.scrollTo({top:0,behavior:'smooth'}); };
    document.getElementById('saveBtn').onclick = ()=>{ saveSession(); document.getElementById('saveBtn').textContent='Guardado'; setTimeout(()=> document.getElementById('saveBtn').textContent='Guardar', 1200)};
    document.getElementById('loadBtn').onclick = ()=>{ loadSession(); document.getElementById('loadBtn').textContent='Cargado'; setTimeout(()=> document.getElementById('loadBtn').textContent='Cargar', 1200)};

    loadSession();
  </script>
</body>
</html>
